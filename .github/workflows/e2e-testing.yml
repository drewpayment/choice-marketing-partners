name: E2E Testing Pipeline

# Disabled: E2E tests require a seeded database schema to run.
# Re-enable once a CI database migration/seed script is added.
# on:
#   pull_request:
#     branches: [ main ]

on:
  workflow_dispatch: # Allow manual triggers only

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: choice_marketing_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Setup test database
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/choice_marketing_test
      run: |
        # TODO: Import database schema here
        echo "Database setup complete"

    - name: Install Playwright Browsers
      run: bunx playwright install --with-deps

    - name: Run Playwright tests
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/choice_marketing_test
        NEXTAUTH_SECRET: test-secret-key
        NEXTAUTH_URL: http://localhost:3000
        BLOB_READ_WRITE_TOKEN: test-token
        NODE_ENV: test
      run: bunx playwright test

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  lighthouse:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build application
      run: bun run build

    - name: Start application
      run: bun run start &
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/choice_marketing_test
        NEXTAUTH_SECRET: test-secret-key
        NEXTAUTH_URL: http://localhost:3000

    - name: Wait for application
      run: npx wait-on http://localhost:3000

    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
